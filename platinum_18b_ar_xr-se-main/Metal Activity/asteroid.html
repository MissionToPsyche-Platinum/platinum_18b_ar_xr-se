<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Psyche Asteroid Value Calculator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0a0a0a;
      color: #f0f0f0;
      text-align: center;
      padding: 30px;
    }

    h1 { margin-bottom: 10px; }

    .asteroid-container {
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 20px auto;
      width: 100%;
    }

    #asteroid-img {
      width: 40%;
      max-width: 320px;
      border-radius: 10px;
      display: block;
      margin: 0 auto;
    }

    #color-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 40%;
      max-width: 320px;
      height: auto;
      aspect-ratio: 1 / 1;
      border-radius: 10px;
      pointer-events: none;
      mix-blend-mode: overlay;
      transition: background-color 0.3s ease;
    }

    .composition-header {
      margin-top: 25px;
    }

    .slider-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px 25px;
      width: 70%;
      max-width: 600px;
      margin: 0 auto;
    }

    .slider-container {
      text-align: left;
    }

    .slider-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }

    input[type=range] {
      width: 100%;
    }

    #junk, #error {
      margin-top: 10px;
      font-weight: bold;
    }
    #junk { color: #0ff; }
    #error { color: red; }

    table {
      margin: 20px auto;
      border-collapse: collapse;
      width: 80%;
      max-width: 600px;
    }
    th, td {
      border: 1px solid #555;
      padding: 8px;
    }
    th { background: #333; }
    #lastUpdated {
      margin-top: 15px;
      font-size: 14px;
      color: #aaa;
    }
    button {
      background: #0ff;
      color: #000;
      border: none;
      padding: 8px 20px;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #09c;
    }
  </style>
</head>
<body>
  <h1>Psyche Asteroid Value Calculator</h1>

  <div class="asteroid-container">
    <img id="asteroid-img" src="Psyche Asteroid.jpg" alt="Psyche Asteroid">
    <div id="color-overlay"></div>
  </div>
  <p style="color:#aaa;font-size:14px;">NASA Psyche Asteroid Visualization</p>
  <p style="color:#0ff;font-size:16px;margin-top:-5px;">
    Estimated Mass: ≈ 2.3 × 10<sup>19</sup> kg (≈ 5.07 × 10<sup>19</sup> lbs)
  </p>

  <h2 class="composition-header">Composition</h2>

  <div class="slider-grid" id="sliders"></div>
  <p id="junk">Junk: 100%</p>
  <p id="error"></p>

  <button id="calcBtn" onclick="calculate()">Calculate</button>

  <h2>Results</h2>
  <table id="resultsTable">
    <thead>
      <tr>
        <th>Metal</th>
        <th>Percentage</th>
        <th>Rate (USD/oz)</th>
        <th>Total Value</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <p id="lastUpdated"></p>

  <script>
    const API_KEY = "LMK8WWQNCCKFV6OL0HQX880OL0HQX";
    const BASE_URL = "https://api.metals.dev/v1/latest";
    const CACHE_KEY = "metalRates";
    const CACHE_TIME_KEY = "metalRatesTimestamp";
    const ONE_DAY_MS = 24 * 60 * 60 * 1000;

    // Fixed mass of Psyche (2.3 × 10^19 kg)
    // Convert to pounds: 1 kg = 2.20462 lbs
    const PSYCHE_MASS_LBS = 2.3e19 * 2.20462;

    const metalsList = ["gold", "silver", "platinum", "palladium", "copper", "nickel", "aluminum", "lead"];

    const metalColors = {
      gold: "#FFD700",
      silver: "#C0C0C0",
      platinum: "#E5E4E2",
      palladium: "#CED0DD",
      copper: "#B87333",
      nickel: "#AFAFAF",
      aluminum: "#D3D3D3",
      lead: "#4D4D4D"
    };

    function lbsToTroyOunces(lbs) {
      const ouncesPerPound = 16;
      const troyOzPerAvoirOz = 0.911458;
      return lbs * ouncesPerPound * troyOzPerAvoirOz;
    }

    function hexToRgb(hex) {
      const bigint = parseInt(hex.slice(1), 16);
      const r = (bigint >> 16) & 255;
      const g = (bigint >> 8) & 255;
      const b = bigint & 255;
      return { r, g, b };
    }

    function mixColors(metalValues) {
      let total = 0;
      let r = 0, g = 0, b = 0;
      for (const [metal, percent] of Object.entries(metalValues)) {
        const color = hexToRgb(metalColors[metal]);
        r += color.r * (percent / 100);
        g += color.g * (percent / 100);
        b += color.b * (percent / 100);
        total += percent;
      }
      if (total === 0) return "rgba(0,0,0,0)";
      r = Math.min(255, Math.round(r));
      g = Math.min(255, Math.round(g));
      b = Math.min(255, Math.round(b));
      const opacity = Math.min(1, total / 100);
      return `rgba(${r}, ${g}, ${b}, ${opacity})`;
    }

    function updateOverlay() {
      const metalValues = {};
      metalsList.forEach(metal => {
        metalValues[metal] = parseInt(document.getElementById(`${metal}-slider`).value);
      });
      const color = mixColors(metalValues);
      document.getElementById("color-overlay").style.backgroundColor = color;
    }

    function buildSliders() {
      const container = document.getElementById("sliders");
      container.innerHTML = "";
      metalsList.forEach(metal => {
        const div = document.createElement("div");
        div.classList.add("slider-container");
        div.innerHTML = `
          <div class="slider-label">
            <span>${metal.charAt(0).toUpperCase() + metal.slice(1)}</span>
            <span id="${metal}-val">0%</span>
          </div>
          <input type="range" min="0" max="100" value="0" id="${metal}-slider"
                 oninput="updatePercent('${metal}')">
        `;
        container.appendChild(div);
      });
    }

    function updatePercent(metal) {
      const slider = document.getElementById(`${metal}-slider`);
      const valueDisplay = document.getElementById(`${metal}-val`);
      valueDisplay.textContent = slider.value + "%";
      validateTotal();
      updateOverlay();
    }

    function validateTotal() {
      let total = 0;
      metalsList.forEach(m => total += parseInt(document.getElementById(`${m}-slider`).value));
      const errorEl = document.getElementById("error");
      const calcBtn = document.getElementById("calcBtn");
      const junkEl = document.getElementById("junk");

      if (total > 100) {
        errorEl.textContent = "❌ Total composition exceeds 100%. Please adjust sliders.";
        calcBtn.disabled = true;
        junkEl.textContent = "Junk: --% (invalid)";
      } else {
        errorEl.textContent = "";
        calcBtn.disabled = false;
        const junk = 100 - total;
        junkEl.textContent = `Junk: ${junk}%`;
      }
    }

    async function getRates() {
      const cached = localStorage.getItem(CACHE_KEY);
      const cachedTime = localStorage.getItem(CACHE_TIME_KEY);

      if (cached && cachedTime && (Date.now() - cachedTime < ONE_DAY_MS)) {
        return { rates: JSON.parse(cached), timestamp: parseInt(cachedTime) };
      }

      try {
        const url = `${BASE_URL}?api_key=${API_KEY}&currency=USD&unit=toz`;
        const resp = await fetch(url);
        const data = await resp.json();
        if (data.status !== "success") throw new Error(data.message || "API error");
        localStorage.setItem(CACHE_KEY, JSON.stringify(data.metals));
        localStorage.setItem(CACHE_TIME_KEY, Date.now());
        return { rates: data.metals, timestamp: Date.now() };
      } catch (err) {
        if (cached) return { rates: JSON.parse(cached), timestamp: cachedTime };
        else throw new Error("No cached rates available.");
      }
    }

    async function calculate() {
      try {
        const { rates, timestamp } = await getRates();
        const totalOunces = lbsToTroyOunces(PSYCHE_MASS_LBS);
        const tbody = document.querySelector("#resultsTable tbody");
        tbody.innerHTML = "";
        let totalValue = 0;

        metalsList.forEach(metal => {
          const percent = parseInt(document.getElementById(`${metal}-slider`).value);
          if (percent > 0 && rates[metal]) {
            const rate = rates[metal];
            const metalOunces = totalOunces * (percent / 100);
            const value = metalOunces * rate;
            totalValue += value;
            tbody.innerHTML += `
              <tr>
                <td>${metal.charAt(0).toUpperCase() + metal.slice(1)}</td>
                <td>${percent}%</td>
                <td>$${rate.toLocaleString(undefined, { maximumFractionDigits: 4 })}</td>
                <td>$${value.toLocaleString(undefined, { maximumFractionDigits: 2 })}</td>
              </tr>
            `;
          }
        });

        tbody.innerHTML += `
          <tr style="font-weight: bold; background: #222;">
            <td colspan="3">TOTAL</td>
            <td>$${totalValue.toLocaleString(undefined, { maximumFractionDigits: 2 })}</td>
          </tr>
        `;
        const date = new Date(parseInt(timestamp));
        document.getElementById("lastUpdated").textContent =
          "Prices last updated: " + date.toLocaleString();
      } catch (err) {
        alert("Could not load prices.");
        console.error(err);
      }
    }

    buildSliders();
    validateTotal();
    updateOverlay();
  </script>
</body>
</html>
